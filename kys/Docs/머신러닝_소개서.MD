# 프로젝트 기술 명세서: 하이브리드 임계값 기반 판매자 리스크 예측 모델

## 1. 프로젝트 개요

본 프로젝트는 Olist 데이터를 활용하여 부실 판매자를 조기에 탐지하는 머신러닝 모델을 구축하는 것을 목표로 합니다. 단순히 모든 판매자에게 동일한 기준을 적용하는 것이 아니라, 판매량에 따라 평가 기준을 차등 적용하는 '차등 임계값 방식을 도입하여 리스크 탐지의 정밀도를 높였습니다.

## 2. 데이터 수집 및 전처리

### 2.1 데이터 로드

- **소스 데이터**: `merged_olist.csv`

### 2.2 데이터 필터링 (책임 소재 명확화)

데이터의 신뢰성을 확보하기 위해 물류사의 과실을 배제하고 판매자의 귀책사유가 명확한 데이터만 선별했습니다.

- **로직**: `is_logistics_fault`가 True이더라도, `seller_delay_days`가 0보다 큰 경우(판매자도 늦게 보낸 경우)는 데이터에 포함합니다. 반면, 순수하게 물류사만 잘못한 건은 제외합니다.
- **결과**: 전체 64,850건 중 1,414건의 순수 물류 과실 데이터를 제거하고 63,436건을 분석에 사용했습니다.

## 3. 피처 엔지니어링

### 3.1 주문 단위변수 생성

개별 주문 건에 대해 성공/실패 여부를 판단하는 이진 변수(Boolean)를 생성했습니다.

- **지연 관련**: `is_processing_delayed` (처리기한 초과), `is_seller_delayed` (판매자 발송기한 초과)
- **리뷰 관련**: `is_negative_review` (평점 3점 이하), `has_delay_comment` (리뷰 텍스트에 '지연', '안 옴' 등의 키워드 포함)
- **복합 불만**: `is_critical_complaint` (부정 리뷰이면서 지연 관련 텍스트가 포함된 경우)

### 3.2 판매자 단위 집계 및 파생 변수

주문 단위 데이터를 `seller_id` 기준으로 그룹화(GroupBy)하여 평균(Mean) 및 표준편차(Std)를 계산하고, 변수 간 상호작용을 고려한 파생 변수를 추가했습니다. 최종적으로 9개의 피처(`feature_9`)를 선정했습니다.

1. **기본 지표**: `order_count`, `text_review_ratio`, `avg_review_score`
2. **리스크 지표**: `processing_delay_rate`, `seller_delay_rate`, `negative_review_rate`, `critical_complaint_rate`
3. **통계 지표**: `processing_days_mean`, `processing_days_std`
4. **상호작용(Interaction) 피처**:

- `delay_negative_interaction`: 출고지연율 부정리뷰율
- `processing_seller_delay_interaction`: 처리지연율 출고지연율
- `total_risk_score`: 주요 리스크 지표의 합 (처리지연+출고지연+부정리뷰)
- `avg_delay_rate`: 지연율의 평균

### 3.3 상관관계 및 다중공선성 분석

모델의 신뢰성과 해석력을 높이기 위해 초기 13개 변수 중 다중공선성을 유발하는 파생 변수(`total_risk_score`, `avg_delay_rate`)와 원본 중복 변수(`seller_delay_rate`)를 학습 피처에서 제외하고, **최종 9개 핵심 피처**를 선별하여 분석을 수행했습니다.

#### **1. 상관관계 분석**

변수 간의 관계를 분석한 결과, 도메인 특성상 필연적인 상관관계만 관측되었습니다.

- **가장 강한 상관관계**: `negative_review_rate`(부정 리뷰율)와 `critical_complaint_rate`(심각한 불만율) 사이에서 나타났습니다.
  이는 '심각한 불만'이 '부정 리뷰'의 부분집합 개념이기에 자연스러운 현상이며, 두 변수 모두 리스크 탐지에 필수적이므로 유지했습니다.

- **상호작용 변수의 관계** : `processing_days_mean`(평균 처리일)과 `processing_seller_delay_interaction`(처리지연$\times$출고지연) 간의 관계입니다. 처리 시간이 길어질수록 지연 관련 상호작용 수치도 높아지는 경향성을 반영합니다.

- **의의**: 그 외 대부분의 변수 쌍은 상관계수가 0.6 미만으로, 변수들이 서로 다른 고유한 정보를 모델에 제공하고 있음을 확인했습니다.

#### **2. 다중공선성 검증**

다중공선성이 통계적으로 매우 안정적인 상태임을 검증했습니다.

- **전반적 안정성**: 전체 9개 피처 중 **8개 피처의 VIF가 5 미만**(`1.11` ~ `4.60`)으로 나타나, 매우 낮은 다중공선성을 보였습니다.

- **최대 VIF**: `processing_days_mean`이 **5.50**으로 측정되었으나, 통상적인 기준인 10보다 훨씬 낮고 엄격한 기준(5.0)을 소폭 상회하는 수준이므로 랜덤 포레스트 모델링에 전혀 문제가 되지 않습니다.

- **전략적 제외**: VIF가 무한대(`inf`)로 발산하던 `seller_delay_rate`는 학습 피처에서 제외하고 타겟 정의 및 '위험 사유 생성' 용도로만 활용하여, 모델의 성능과 해석의 명확성을 동시에 확보했습니다.

## 4. 타겟 정의

판매 규모가 다른 판매자들을 동일 선상에서 비교하는 오류를 범하지 않기 위해 '차등 접근법'을 사용했습니다.

- **Group A (대형 판매자)**: 주문 건수 상위 25% (16건 이상). 상대적으로 엄격한 관리가 필요하므로 완화된 임계값(상위 75% 지점)을 적용하여 사소한 리스크도 감지합니다.
- **Group B (중소형 판매자)**: 주문 건수 하위 75% (5~15건). 데이터 민감도가 높으므로 엄격한 임계값(상위 90% 지점)을 적용하여 확실한 리스크만 감지합니다.
- **Target (`is_Seller_of_Note`)**: 각 그룹의 임계값을 초과하는 판매자를 '관리 대상(1)', 그 외를 '정상(0)'으로 정의했습니다.
- **데이터 불균형**: 전체 1,420명 중 약 5.2%인 74명만이 관리 대상으로 분류되었습니다.

## 5. 모델링 (Modeling)

### 5.1 모델 구성

- **알고리즘**: `RandomForestClassifier`
- **설정**: `n_estimators=250`, `max_depth=8`, `random_state=42`
- **불균형 처리**: `class_weight='balanced'` 옵션을 사용하여 소수 클래스(관리 대상)에 가중치를 부여했습니다.

### 5.2 교차 검증

데이터 편향을 방지하기 위해 `StratifiedKFold` (10-split)를 사용하여 모델을 검증했습니다.

- **검증 결과**:
- 평균 Precision: 0.8762
- 평균 Recall: 0.8625
- 평균 F1-Score: 0.8643
- 결론: 과적합 없이 안정적인 성능을 보여줍니다.

## 6. 성능 최적화 및 평가

### 6.1 임계값 튜닝

기본 임계값(0.5) 대신, 리스크 판매자를 놓치지 않는 것(Recall)을 최우선으로 하되 정밀도(Precision)와의 균형을 맞추기 위해 임계값을 조정했습니다.

- **최적 임계값**: **0.40**
- **최종 성능**:
- Precision: 0.88
- Recall: 1.00
- F1-Score: 0.94

### 6.2 피처 중요도

모델은 단일 변수보다 복합적인 상황을 나타내는 변수를 중요하게 평가했습니다.

1. `delay_negative_interaction`: 지연과 고객 불만이 동시에 발생하는 상황
2. `processing_seller_delay_interaction`: 내부 프로세스와 출고가 모두 늦는 상황
3. `total_risk_score`: 종합 리스크 점수

### 7. 결과물 및 활용 방안

#### 7.1 리스크 사유 생성

예측 결과의 설득력을 높이기 위해, 각 판매자가 왜 위험군으로 분류되었는지 설명하는 텍스트 생성 로직을 구현했습니다.

- 예: "처리지연율 높음(84%) | 부정리뷰율 높음(48%)"

#### 7.2 최종 리포트

전체 판매자를 대상으로 예측을 수행하고, 예측 확률에 따라 4단계 등급을 부여한 `risk_report_result.csv`를 생성했습니다. 이 CSV 파일은 단순한 결과 저장에 그치지 않고, 후속 시스템의 핵심 데이터 소스로 활용됩니다.

- **RED (위험)**: 확률 0.8 이상 (즉시 조치 필요)
- **ORANGE (경고)**: 확률 0.4 ~ 0.8 (모니터링 필요)
- **YELLOW (주의)**: 확률 0.3 ~ 0.4
- **GREEN (정상)**: 확률 0.3 미만

#### 7.3 시스템 연동 및 활용

본 프로젝트의 최종 산출물인 `risk_report_result.csv`는 **관리자용 대시보드**와 **자동 메일링 시스템**이라는 두 가지 핵심 운영 시스템과 유기적으로 연동되어, 리스크 탐지부터 대응까지의 전 과정을 자동화합니다.

**1. Olist 비즈니스 통합 대시보드 (`dashboard.py`)**
Streamlit 기반의 웹 애플리케이션으로, 전체 비즈니스 건전성과 판매자 리스크를 한 화면에서 직관적으로 파악할 수 있도록 설계되었습니다.

- **실시간 리스크 시뮬레이션** :
  - 사이드바의 위험 확률 기준(Threshold) 슬라이더를 통해 관리자가 리스크 민감도(0.0 ~ 1.0)를 직접 조정할 수 있습니다.
  - 조정 즉시 대시보드 내의 '감지된 위험 판매자 수'와 'Top 10 리스크 차트'가 동적으로 변화하여, 규제 강도에 따른 파급 효과를 실시간으로 시뮬레이션할 수 있습니다.
- **등급별 현황판**:
  - RED, ORANGE, YELLOW 등급별 판매자 수를 실시간 KPI로 보여줍니다.
- **상세 분석 테이블**:

  - 고위험 판매자 목록을 테이블 형태로 제공하며, 다양한 곳에 활용할 수 있도록 **CSV 다운로드 기능**을 지원합니다.

- **데이터 파이프라인 자동화**:
  - 사이드바의 **`데이터 갱신` 버튼**을 통해 백그라운드에서 모델링 스크립트(`generate_risk_report`)를 즉시 실행할 수 있습니다. 이를 통해 새로운 주문 데이터가 들어오더라도 별도의 코드 실행 없이 최신 리스크 분석 결과를 대시보드에 반영할 수 있습니다.

**2. 4단계 자동화 리포팅 시스템 (`kys_Mailing.py`)**
대시보드와 동일한 데이터 소스를 사용하여, 매일 정해진 시각에 이메일로 리스크 리포트를 발송합니다.

- **등급별 자동 분류**: 예측 확률에 따라 RED(즉각 제재), ORANGE(집중 모니터링), YELLOW(관찰), GREEN(우수)으로 자동 분류합니다.
- **Actionable Report**: HTML 형식의 메일 본문에 각 등급별로 취해야 할 구체적인 행동 지침(Action Plan)과 대상자 목록을 포함하여 발송합니다.
